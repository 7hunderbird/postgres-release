#!/bin/bash -exu

source /var/vcap/jobs/postgres/bin/pgconfig.sh

function main() {
  if [[ -d "${STORE_DIR}/postgres-9.4.6" ]]; then
    chown -R vcap:vcap "${STORE_DIR}/postgres-9.4.6"
    chmod 700 "${STORE_DIR}/postgres-9.4.6"
  fi

  if [[ -d "${STORE_DIR}/postgres-9.4.5" ]]; then
    chown -R vcap:vcap "${STORE_DIR}/postgres-9.4.5"
    chmod 700 "${STORE_DIR}/postgres-9.4.5"
  fi

  mkdir -p "${LOG_DIR}"
  chown -R vcap:vcap "${LOG_DIR}"

  mkdir -p "${DATA_DIR}"
  chown -R vcap:vcap "${DATA_DIR}"
  chmod 700 "${DATA_DIR}"

  mkdir -p "${DATA_DIR_PREVIOUS}"
  chown -R vcap:vcap "${DATA_DIR_PREVIOUS}"
  chmod 700 "${DATA_DIR_PREVIOUS}"

  mkdir -p "${RUN_DIR}"
  chown -R vcap:vcap "${RUN_DIR}"

  mkdir -p "${JOB_DIR}"
  chown -R vcap:vcap "${JOB_DIR}"

  mkdir -p "${PACKAGE_DIR}"
  chown -R vcap:vcap "${PACKAGE_DIR}"

  sysctl -w "kernel.shmmax=284934144"
}

main
