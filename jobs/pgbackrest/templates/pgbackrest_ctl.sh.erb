#!/bin/bash -eu

export PIDNUM=$$

exec > >(tee -a >(logger -p user.info -t vcap.$(basename $0).stdout) | awk -W interactive '{ system("echo -n [$(date +\"%Y-%m-%d %H:%M:%S%z\")] $PIDNUM"); print " " $0 }' >> /var/vcap/sys/log/pgbackrest/$(basename $0).log)
exec 2> >(tee -a >(logger -p user.error -t vcap.$(basename $0).stderr) | awk -W interactive '{ system("echo -n [$(date +\"%Y-%m-%d %H:%M:%S%z\")] $PIDNUM"); print " " $0 }' >> /var/vcap/sys/log/pgbackrest/$(basename $0).err.log)

function main() {
  local action
  action="${1}"

  source /var/vcap/jobs/pgbackrest/config/config.sh
  set +u
  source /var/vcap/packages/postgres-common/utils.sh
  set -u

  case "${action}" in
    "start")
      mkdir -p "${RUN_DIR}"
      pid_guard "${PIDFILE}" "Pgbackrest"

      echo $$ > "${PIDFILE}"
      exec ${JOB_DIR}/bin/backup_scheduler.sh
      ;;

    "stop")
      echo "Stopping Pgbackrest"
      kill_and_wait "${PIDFILE}"
      ;;

    *)
      echo "Usage: ${0} {start|stop}"
      exit 1

      ;;

  esac
}

main "${1}"
