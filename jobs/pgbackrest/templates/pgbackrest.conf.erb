<%
dbhost = "localhost"
sslmode = "prefer"
port = p("postgres.port")
dbuser = p("postgres.dbuser")
if_link("database") do |data|
  if dbuser != "vcap"
    dbhost = data.address
  end

  port = data.p("databases.port")
end

 %>
[global]
repo1-path=/var/vcap/store/pgbackrest
repo1-retention-full=2
repo1-retention-diff=2

<% if p('pgbackrest.cipher_pass') != '' %>
repo1-cipher-pass=<%= p('pgbackrest.cipher_pass') %>
repo1-cipher-type=aes-256-cbc
<% else %>
repo1-cipher-type=none
<% end %>

#start-fast=n
#stop-auto=y
#process-max=4
log-path=/var/vcap/sys/log/pgbackrest

[global:archive-push]
compress-level=3

[<%= p('pgbackrest.stanza') %>]
pg1-path=/var/vcap/store/postgres/postgres-11.1
pg1-port=<%= port %>
pg1-socket-path=/tmp
#pg1-host=<%= dbhost %>
#pg1-host-port=<%= port %>
#pg1-host-user=<%= dbuser %>
recovery-option=recovery_target_action=promote

