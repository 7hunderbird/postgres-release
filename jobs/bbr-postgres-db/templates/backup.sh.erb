#!/bin/bash -e
source /var/vcap/jobs/bbr-postgres-db/config/config.sh

trap rm ~/.pgpass EXIT

cp $JOB_DIR/config/.pgpass ~/.pgpass
chmod 0600 ~/.pgpass

for dbname in ${DATABASES[@]}; do
  BBR_ARTIFACT_FILE_PATH="${BBR_ARTIFACT_DIRECTORY}/postgres_${dbname}.sql"
  PGPASSFILE=~/.pgpass ${PACKAGE_DIR}/bin/pg_dump \
    --verbose \
    --username="<%= p("postgres.dbuser") %>" \
    --host=localhost \
    --port="${PORT}" \
    --format=custom \
    --file="${BBR_ARTIFACT_FILE_PATH}" \
    "${dbname}"
done
